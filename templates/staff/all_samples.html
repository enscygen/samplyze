{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
    <h1 class="h2">All Samples Dashboard</h1>
</div>

<!-- NEW: Section for displaying status counts -->
<div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-wrap justify-content-start gap-3">
        <span class="badge sample-overview-counter text-dark bg-light border">Total Visible: <span id="count-total">0</span></span>
        <span class="badge sample-overview-counter bg-secondary">Submitted: <span id="count-submitted">0</span></span>
        <span class="badge sample-overview-counter bg-primary">In Progress: <span id="count-in-progress">0</span></span>
        <span class="badge sample-overview-counter bg-warning text-dark">Analysis Complete: <span id="count-analysis-complete">0</span></span>
        <span class="badge sample-overview-counter bg-success">Report Ready: <span id="count-report-ready">0</span></span>
        <span class="badge sample-overview-counter bg-dark">Disposed: <span id="count-disposed">0</span></span>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col-md-5">
                <h5 class="mb-0">All Submitted Samples</h5>
            </div>
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Live search by Sample UID, Name, Applicant, Status...">
            </div>
            <div class="col-md-3">
                <div class="form-check form-switch float-end">
                    <input class="form-check-input" type="checkbox" role="switch" id="assignedToMeCheck" {% if assigned_to_me %}checked{% endif %}>
                    <label class="form-check-label" for="assignedToMeCheck">Show my assigned samples only</label>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Sample UID</th>
                        <th>Sample Name</th>
                        <th>Applicant</th>
                        <th>Status</th>
                        <th>Submitted On</th>
                        <th>Assigned To</th>
                        <th>Department</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sampleTable">
                    {% for sample in samples %}
                    <tr>
                        <td><a href="{{ url_for('view_sample', sample_uid=sample.sample_uid) }}" class="fw-bold">{{ sample.sample_uid }}</a></td>
                        <td>{{ sample.sample_name }}</td>
                        <td><a href="{{ url_for('view_applicant', uid=sample.applicant.uid) }}">{{ sample.applicant.name }}</a></td>
                        <td>
                            {% set status_color = 'secondary' %}
                            {% if sample.current_status == 'In Progress' %}
                                {% set status_color = 'primary' %}
                            {% elif sample.current_status == 'Analysis Complete' %}
                                {% set status_color = 'warning' %}
                            {% elif sample.current_status == 'Report Ready' %}
                                {% set status_color = 'success' %}
                            {% elif sample.current_status == 'Disposed' %}
                                {% set status_color = 'dark' %}
                            {% endif %}
                            <span class="badge bg-{{ status_color }}">{{ sample.current_status }}</span>
                        </td>
                        <td>{{ sample.submission_date.strftime('%d-%b-%Y') }}</td>
                        <td>{{ sample.assigned_staff.name if sample.assigned_staff else 'N/A' }}</td>
                        <td>{{ sample.allotted_department.name if sample.allotted_department else 'N/A' }}</td>
                        <td>
                            <a href="{{ url_for('view_sample', sample_uid=sample.sample_uid) }}" class="btn btn-sm btn-info"><i class="bi bi-eye"></i></a>
                            <a href="{{ url_for('edit_sample', sample_uid=sample.sample_uid) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No samples found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('sampleTable');
    const rows = tableBody.getElementsByTagName('tr');
    const assignedToMeCheck = document.getElementById('assignedToMeCheck');

    // NEW: Function to calculate and update status counts
    function updateStatusCounts() {
        const counts = {
            'Submitted': 0,
            'In Progress': 0,
            'Analysis Complete': 0,
            'Report Ready': 0,
            'Disposed': 0,
            'Total': 0
        };

        for (let i = 0; i < rows.length; i++) {
            // Only count rows that are currently visible
            if (rows[i].style.display !== 'none') {
                counts.Total++;
                const statusCell = rows[i].getElementsByTagName('td')[3]; // Status is the 4th column
                if (statusCell) {
                    const statusText = statusCell.textContent.trim();
                    if (counts.hasOwnProperty(statusText)) {
                        counts[statusText]++;
                    }
                }
            }
        }

        // Update the HTML badges with the new counts
        document.getElementById('count-total').textContent = counts.Total;
        document.getElementById('count-submitted').textContent = counts['Submitted'];
        document.getElementById('count-in-progress').textContent = counts['In Progress'];
        document.getElementById('count-analysis-complete').textContent = counts['Analysis Complete'];
        document.getElementById('count-report-ready').textContent = counts['Report Ready'];
        document.getElementById('count-disposed').textContent = counts['Disposed'];
    }

    // Live search functionality
    searchInput.addEventListener('keyup', function(event) {
        const filter = event.target.value.toLowerCase();
        
        for (let i = 0; i < rows.length; i++) {
            let cells = rows[i].getElementsByTagName('td');
            let found = false;
            for (let j = 0; j < cells.length - 1; j++) {
                if (cells[j]) {
                    if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }
            if (found) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
        // Update counts after filtering
        updateStatusCounts();
    });

    // Checkbox filter functionality
    assignedToMeCheck.addEventListener('change', function() {
        const baseUrl = '{{ url_for("all_samples") }}';
        if (this.checked) {
            window.location.href = baseUrl + '?assigned_to_me=true';
        } else {
            window.location.href = baseUrl;
        }
    });
    
    // Initial count on page load
    updateStatusCounts();
});
</script>
{% endblock %}
